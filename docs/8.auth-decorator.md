

# Authorization + AuthDecorator


## 1. AuthDecorator 구현

### 목적 
- 미들웨어에서 사용자 정보를 req 객체에 넣었다.  
- controller 에서 req객체를 뒤적거리어서 사용자 객체를 얻을 수 있다.  
- 위 반복적인 코드를 데코레이터로 만들고자 한다.  


### 로직  
1. createParamDecorator을 구현하여 ExecutionContext 을 가져온다.
2. req에서 사용자 정보를 가져와서 리턴하도록 한다.  

### 구현  

```ts
import {
  createParamDecorator,
  ExecutionContext,
  SetMetadata,
} from '@nestjs/common';
import { MemberInfo } from 'src/member/entities';

export const AuthUser = createParamDecorator( // createParamDecorator 가져ㅇ옴
  (data: unknown, context: ExecutionContext): MemberInfo => {
      // ExecutionContext 실행 컨테스트가 http 프로토콜을 이용하고
      //  Http 변환 후 request객체를 얻어, memberInfo 을 리턴 하도록 한다.
    if (
      context['contextType'] &&
      String(context['contextType']).startsWith('http')
    ) {
      const request = context.switchToHttp().getRequest();
      return request['memberInfo'];
    }
  },
);

export type AllowRoles = keyof typeof UserRole | 'Any';
export const Roles = (roles: AllowRoles[]) => SetMetadata('roles', roles);

```
## 2. Authorization 구현